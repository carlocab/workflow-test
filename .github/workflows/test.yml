name: CI
on: [push, pull_request, workflow_dispatch]

env:
  HOMEBREW_DEVELOPER: 1
  HOMEBREW_SIMULATE_MACOS_ON_LINUX: 1

jobs:
  tests:
    name: Miscellaneous `brew` tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-10.15, macos-11, macos-12, ubuntu-latest]
      fail-fast: false
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Profile tap_syntax test (before)
        run: |
          brew prof --stackprof audit --tap=homebrew/core --except=version
          mv prof prof-before

      - name: Fetch GCC audit PR
        run: |
          git config --global user.email "30379873+carlocab@users.noreply.github.com"
          git config --global user.name "Carlo Cabrera"
          pushd "$(brew --repository)"
          git fetch origin pull/13648/head:gcc
          git cherry-pick 4302af67b7e4e772342449fb888bcf4f3595d60c 718cf8b0df5666001dce4fa73a88c70218b98252
          popd

      - name: Profile tap_syntax test (after)
        run: |
          brew prof --stackprof audit --tap=homebrew/core --except=version
          mv prof prof-after

      - name: Upload results
        uses: actions/upload-artifact@main
        with:
          name: prof-${{ matrix.os }}
          path: prof-*
